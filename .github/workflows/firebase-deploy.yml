name: Deploy NCLEX Library Safe

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy_hosting:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # GENERADOR DE CAT√ÅLOGO (Solo Texto - No falla nunca)
      - name: Generate library/catalog.json
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          node -e '
            const fs = require("fs");
            const path = require("path");

            async function generate() {
              console.log("ü§ñ Iniciando generador de cat√°logo...");
              const repo = process.env.REPO;
              // Usamos la API de GitHub para leer el release "BOOKS"
              const url = `https://api.github.com/repos/${repo}/releases/tags/BOOKS`;
              
              try {
                const res = await fetch(url, {
                  headers: { "Authorization": `Bearer ${process.env.GH_TOKEN}`, "User-Agent": "NCLEX-Bot" }
                });
                
                if (!res.ok) {
                   console.log("‚ö†Ô∏è No se detect√≥ Release BOOKS. Se publicar√° cat√°logo vac√≠o.");
                   return; // No rompemos el deploy, solo no generamos nada.
                }

                const data = await res.json();
                const assets = data.assets || [];
                
                // Mapear archivos PDF a formato JSON
                const items = assets
                  .filter(a => a.name.toLowerCase().endsWith(".pdf"))
                  .map(a => {
                    const cleanName = a.name.replace(/_/g, " ").replace(/\.pdf$/i, "");
                    // Creamos un ID seguro
                    const id = cleanName.replace(/[^a-zA-Z0-9]/g, "").toLowerCase().substring(0, 20);
                    
                    return {
                      id: id,
                      title: { es: cleanName, en: cleanName },
                      type: "pdf",
                      fileUrl: a.browser_download_url,
                      coverUrl: "", // Lo dejamos vac√≠o, el JS generar√° el arte
                      addedAt: new Date(a.created_at).getTime()
                    };
                  });

                // Crear carpeta y guardar
                const dir = path.join(process.cwd(), "library");
                if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
                
                fs.writeFileSync(path.join(dir, "catalog.json"), JSON.stringify(items, null, 2));
                console.log(`‚úÖ Cat√°logo generado con ${items.length} libros.`);
                
              } catch (error) {
                console.error("Error leve generando cat√°logo:", error);
                // No hacemos process.exit(1) para que el deploy contin√∫e s√≠ o s√≠
              }
            }
            generate();
          '

      # DESPLIEGUE A FIREBASE
      - name: Firebase Deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_NCLEX_LIBRARY_9E9E7 }}
          channelId: live
          projectId: nclex-library-9e9e7
