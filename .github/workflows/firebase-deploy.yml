name: Auto Deploy & Catalog Generator

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy_hosting:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # --- EL ROBOT GENERA EL CAT√ÅLOGO AQU√ç ---
      - name: Generate library/catalog.json automatically
        env:
          # Usamos el token autom√°tico de GitHub para leer tus Releases
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
          REPO: ${{ github.repository }}
          TAG: BOOKS
        run: |
          node -e '
            const fs = require("fs");
            const path = require("path");

            async function generate() {
              console.log("ü§ñ Iniciando generaci√≥n autom√°tica del cat√°logo...");
              
              // 1. Obtener la lista de archivos del Release "BOOKS"
              const apiUrl = `https://api.github.com/repos/${process.env.REPO}/releases/tags/${process.env.TAG}`;
              console.log(`üì° Consultando: ${apiUrl}`);
              
              const res = await fetch(apiUrl, {
                headers: { 
                  "Authorization": `Bearer ${process.env.GH_TOKEN}`,
                  "User-Agent": "NCLEX-Auto-Builder"
                }
              });

              if (!res.ok) {
                console.warn("‚ö†Ô∏è No se encontr√≥ el Release BOOKS o hubo un error. Se dejar√° el cat√°logo vac√≠o.");
                // Si falla, no rompemos el deploy, solo dejamos aviso.
                return; 
              }

              const releaseData = await res.json();
              const assets = releaseData.assets || [];
              console.log(`üìö Encontrados ${assets.length} archivos en el Release.`);

              // 2. Convertir archivos a formato NCLEX Catalog
              const items = assets
                .filter(a => a.name.toLowerCase().endsWith(".pdf")) // Solo PDFs
                .map(a => {
                  // Limpiar nombre para el t√≠tulo (quitar _ y .pdf)
                  const simpleName = a.name.replace(/_/g, " ").replace(/\.pdf$/i, "");
                  
                  return {
                    id: a.id.toString(),
                    title: { es: simpleName, en: simpleName },
                    author: "NCLEX Library",
                    type: "pdf",
                    // Usamos el link directo de descarga de GitHub
                    fileUrl: a.browser_download_url, 
                    coverUrl: "", // No hay car√°tula local, usar√° el dise√±o autom√°tico de colores
                    tags: ["NCLEX"],
                    addedAt: new Date(a.created_at).getTime(),
                    source: "github_auto"
                  };
                });

              // 3. Guardar el archivo catalog.json
              const outDir = path.join(process.cwd(), "library");
              if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });
              
              const outFile = path.join(outDir, "catalog.json");
              fs.writeFileSync(outFile, JSON.stringify(items, null, 2));
              
              console.log(`‚úÖ Cat√°logo generado con √©xito en: ${outFile}`);
              console.log(JSON.stringify(items, null, 2)); // Mostrar en log para debug
            }

            generate().catch(err => {
              console.error("‚ùå Error fatal generando cat√°logo:", err);
              process.exit(1);
            });
          '

      # --- PUBLICAR A FIREBASE ---
      - name: Firebase Deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_NCLEX_LIBRARY_9E9E7 }}
          channelId: live
          projectId: nclex-library-9e9e7
