name: Deploy Manual Seguro

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy_hosting:
    runs-on: ubuntu-latest

    steps:
      # 1. Descargar tu cÃ³digo
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Instalar Node.js
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. Generar el CatÃ¡logo (Script de Node simple)
      - name: Generar Catalogo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          node -e '
            const fs = require("fs");
            const path = require("path");
            
            async function run() {
              console.log("ðŸ¤– Generando catÃ¡logo...");
              const url = `https://api.github.com/repos/${process.env.REPO}/releases/tags/BOOKS`;
              
              try {
                const res = await fetch(url, { headers: { "Authorization": `Bearer ${process.env.GH_TOKEN}`, "User-Agent": "NCLEX-Bot" } });
                if(!res.ok) throw new Error("No se encontrÃ³ el Release BOOKS");
                
                const data = await res.json();
                const items = (data.assets || [])
                  .filter(a => a.name.toLowerCase().endsWith(".pdf"))
                  .map(a => {
                     const name = a.name.replace(/_/g, " ").replace(/\.pdf$/i, "");
                     return {
                       id: name.replace(/[^a-zA-Z0-9]/g, "").substring(0,15),
                       title: { es: name, en: name },
                       type: "pdf",
                       fileUrl: a.browser_download_url,
                       coverUrl: "", 
                       addedAt: new Date(a.created_at).getTime()
                     };
                  });
                
                const dir = "library";
                if (!fs.existsSync(dir)) fs.mkdirSync(dir);
                fs.writeFileSync(`${dir}/catalog.json`, JSON.stringify(items, null, 2));
                console.log(`âœ… CatÃ¡logo creado con ${items.length} libros.`);
              } catch (e) {
                console.log("âš ï¸ Aviso: " + e.message);
                // Si falla, creamos uno vacÃ­o para no romper la web
                if (!fs.existsSync("library/catalog.json")) {
                   fs.mkdirSync("library", {recursive:true});
                   fs.writeFileSync("library/catalog.json", "[]");
                }
              }
            }
            run();
          '

      # 4. INSTALAR Y SUBIR A FIREBASE (Modo Directo)
      - name: Deploy to Firebase
        env:
          # Decodificamos tu llave secreta directamente
          SA_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_NCLEX_LIBRARY_9E9E7 }}
          PROJECT_ID: nclex-library-9e9e7
        run: |
          # Instalar herramienta oficial
          npm install -g firebase-tools
          
          # Crear archivo de credenciales temporal
          echo "$SA_KEY" > service_account.json
          export GOOGLE_APPLICATION_CREDENTIALS=service_account.json
          
          # Subir SOLO el hosting (sin intentar compilar nada)
          firebase deploy --only hosting --project $PROJECT_ID --json
