name: Auto Deploy (GitHub -> Firebase) + Auto Catalog (Release BOOKS)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 1) Genera /library/catalog.json leyendo TODOS los assets del release BOOKS (paginado)
      - name: Generate library/catalog.json from Release BOOKS (all assets)
        env:
          REPO: Nclexpass/NCLEX1.2
          TAG: BOOKS
        run: |
          node - <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const REPO = process.env.REPO;
          const TAG  = process.env.TAG;

          async function fetchJson(url) {
            const res = await fetch(url, {
              headers: {
                'Accept': 'application/vnd.github+json',
                'User-Agent': 'nclex-auto-catalog'
              }
            });
            if (!res.ok) {
              const txt = await res.text();
              throw new Error(`GitHub API error ${res.status}: ${txt}`);
            }
            return res.json();
          }

          function prettifyTitle(filename) {
            return String(filename || '')
              .replace(/\.pdf$/i, '')
              .replace(/[_]+/g, ' ')
              .replace(/[.]+/g, ' ')
              .replace(/\s+/g, ' ')
              .trim();
          }

          function makeId(filename) {
            const base = String(filename || '').replace(/\.pdf$/i, '');
            return base
              .toLowerCase()
              .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
              .replace(/[^a-z0-9]+/g, '_')
              .replace(/^_+|_+$/g, '');
          }

          async function main() {
            const releaseApi = `https://api.github.com/repos/${REPO}/releases/tags/${encodeURIComponent(TAG)}`;
            const release = await fetchJson(releaseApi);

            const assetsUrl = release.assets_url;
            if (!assetsUrl) throw new Error('Release assets_url missing');

            let page = 1;
            let allAssets = [];
            while (true) {
              const url = `${assetsUrl}?per_page=100&page=${page}`;
              const batch = await fetchJson(url);
              if (!Array.isArray(batch) || batch.length === 0) break;
              allAssets = allAssets.concat(batch);
              if (batch.length < 100) break;
              page++;
              if (page > 50) break;
            }

            const pdfs = allAssets.filter(a => {
              const ct = String(a.content_type || '').toLowerCase();
              const nm = String(a.name || '').toLowerCase();
              return ct.includes('pdf') || nm.endsWith('.pdf');
            });

            pdfs.sort((a,b) => String(a.name||'').localeCompare(String(b.name||'')));

            const now = Date.now();
            const items = pdfs.map((a, idx) => {
              const name = String(a.name || `book_${idx}.pdf`);
              const title = prettifyTitle(name);
              return {
                id: makeId(name) || `book_${idx}`,
                title: { es: title, en: title },
                author: "",
                type: "pdf",
                fileUrl: a.browser_download_url,
                coverUrl: "",
                tags: ["NCLEX"],
                addedAt: now + idx,
                source: "github_release_books"
              };
            });

            const outDir  = path.join(process.cwd(), 'library');
            const outFile = path.join(outDir, 'catalog.json');
            if (!fs.existsSync(outDir)) fs.mkdirSync(outDir, { recursive: true });

            fs.writeFileSync(outFile, JSON.stringify(items, null, 2), 'utf8');
            console.log(`OK: catalog.json generado con ${items.length} libros -> ${outFile}`);
          }

          main().catch(err => {
            console.error(err);
            process.exit(1);
          });
          NODE

      # 2) Deploy REAL a Firebase Hosting (SIN target)
      - name: Firebase Deploy (Hosting)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: nclex-library-9e9e7
          channelId: live
          entryPoint: .
