name: Auto Deploy & Cover Generator

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write
  id-token: write

jobs:
  deploy_hosting:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      # 1. Instalar herramientas para procesar PDFs (Poppler)
      - name: Install PDF Tools
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      # 2. Configurar Python para el script de im√°genes
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 3. EL GRAN SCRIPT: Descarga PDFs, extrae la portada y genera el cat√°logo
      - name: Generate Catalog & Covers
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          python3 - << 'EOF'
          import os, json, subprocess, sys
          from urllib.request import Request, urlopen

          # Configuraci√≥n
          repo = os.environ['REPO']
          tag = "BOOKS"
          api_url = f"https://api.github.com/repos/{repo}/releases/tags/{tag}"
          token = os.environ['GH_TOKEN']
          
          # Carpetas de salida
          covers_dir = "library/files/covers"
          os.makedirs(covers_dir, exist_ok=True)
          os.makedirs("library/files", exist_ok=True)

          print(f"ü§ñ Conectando a Release: {tag}...")
          
          # Obtener lista de archivos del Release
          req = Request(api_url, headers={"Authorization": f"Bearer {token}", "User-Agent": "NCLEX-Bot"})
          try:
              data = json.loads(urlopen(req).read())
          except Exception as e:
              print(f"‚ö†Ô∏è Error accediendo al Release (quiz√°s no existe 'BOOKS'): {e}")
              sys.exit(0) # Salir sin error para no romper el deploy

          assets = data.get("assets", [])
          print(f"üìö Archivos encontrados: {len(assets)}")

          catalog = []
          
          for asset in assets:
              name = asset["name"]
              if not name.lower().endswith(".pdf"):
                  continue
                  
              print(f"‚ö° Procesando: {name}")
              
              # Limpiar nombre para t√≠tulo e ID
              clean_name = name.replace("_", " ").replace(".pdf", "").replace(".PDF", "")
              safe_id = "".join([c if c.isalnum() else "_" for c in clean_name]).strip("_")
              
              # URLs
              pdf_url = asset["browser_download_url"]
              cover_filename = f"{safe_id}.jpg"
              cover_path_local = os.path.join(covers_dir, cover_filename)
              cover_url_web = f"/library/files/covers/{cover_filename}"
              
              # GENERAR PORTADA (Descarga parcial -> Convertir -> JPG)
              # Usamos curl para bajar el PDF temporalmente
              tmp_pdf = "temp_book.pdf"
              subprocess.run(["curl", "-L", "-H", f"Authorization: Bearer {token}", "-o", tmp_pdf, pdf_url], check=True)
              
              # Usar pdftoppm para sacar la primera p√°gina como JPG
              # -f 1 -l 1: Solo p√°gina 1
              # -scale-to 400: Ancho 400px (calidad buena para web)
              try:
                  subprocess.run([
                      "pdftoppm", "-jpeg", "-f", "1", "-l", "1", 
                      "-scale-to", "400", tmp_pdf, "cover_tmp"
                  ], check=True)
                  
                  # pdftoppm genera 'cover_tmp-1.jpg', lo renombramos
                  if os.path.exists("cover_tmp-1.jpg"):
                      os.replace("cover_tmp-1.jpg", cover_path_local)
                      print(f"   ‚úÖ Portada creada: {cover_filename}")
                  else:
                      print("   ‚ö†Ô∏è No se gener√≥ la imagen.")
                      cover_url_web = "" # Sin portada
              except Exception as e:
                  print(f"   ‚ùå Error generando portada: {e}")
                  cover_url_web = ""

              # Agregar al cat√°logo
              catalog.append({
                  "id": safe_id,
                  "title": {"es": clean_name, "en": clean_name},
                  "author": "NCLEX Library",
                  "type": "pdf",
                  "fileUrl": pdf_url,
                  "coverUrl": cover_url_web,
                  "tags": ["NCLEX"],
                  "addedAt": 1700000000000, # Fecha fija o din√°mica
                  "source": "github_auto"
              })
              
              # Limpieza
              if os.path.exists(tmp_pdf): os.remove(tmp_pdf)

          # Guardar JSON
          with open("library/catalog.json", "w") as f:
              json.dump(catalog, f, indent=2)
              
          print("üíæ Cat√°logo guardado en library/catalog.json")
          EOF

      # 4. Publicar a Firebase
      - name: Firebase Deploy
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_NCLEX_LIBRARY_9E9E7 }}
          channelId: live
          projectId: nclex-library-9e9e7
