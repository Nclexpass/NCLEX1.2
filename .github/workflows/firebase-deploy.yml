name: Deploy Manual Directo

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy_hosting:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      # 1. Bajar tu c√≥digo
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Preparar el entorno (Node.js)
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3. GENERADOR DE CAT√ÅLOGO (Script seguro que no rompe el deploy)
      - name: Generar Catalogo
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # Creamos el script JS en el momento para evitar errores de sintaxis YAML
          cat << 'EOF' > generate_catalog.js
          const fs = require('fs');
          const path = require('path');
          
          async function run() {
            try {
              console.log("ü§ñ Buscando libros en GitHub Releases...");
              const repo = process.env.REPO;
              // Usamos la API p√∫blica si es posible, o con token
              const headers = { 'User-Agent': 'NCLEX-Bot' };
              if (process.env.GH_TOKEN) headers['Authorization'] = `Bearer ${process.env.GH_TOKEN}`;
              
              const res = await fetch(`https://api.github.com/repos/${repo}/releases/tags/BOOKS`, { headers });
              
              if (!res.ok) {
                console.log("‚ö†Ô∏è No se encontr√≥ el Release 'BOOKS'. Se crear√° cat√°logo vac√≠o.");
                writeCatalog([]);
                return;
              }
              
              const data = await res.json();
              const items = (data.assets || [])
                .filter(a => a.name.toLowerCase().endsWith('.pdf'))
                .map(a => {
                  const cleanName = a.name.replace(/_/g, ' ').replace(/\.pdf$/i, '');
                  // ID seguro solo letras y numeros
                  const safeId = cleanName.replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
                  
                  return {
                    id: safeId,
                    title: { es: cleanName, en: cleanName },
                    type: 'pdf',
                    fileUrl: a.browser_download_url,
                    coverUrl: '', // El JS del frontend generar√° el arte
                    addedAt: new Date(a.created_at).getTime()
                  };
                });
                
              writeCatalog(items);
              console.log(`‚úÖ Cat√°logo generado con ${items.length} libros.`);
              
            } catch (e) {
              console.error("‚ùå Error generando cat√°logo:", e.message);
              // En caso de error, creamos uno vac√≠o para que la web no rompa
              writeCatalog([]);
            }
          }

          function writeCatalog(items) {
            const dir = 'library';
            if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
            fs.writeFileSync(path.join(dir, 'catalog.json'), JSON.stringify(items, null, 2));
          }

          run();
          EOF
          
          # Ejecutar el script que acabamos de crear
          node generate_catalog.js

      # 4. INSTALAR FIREBASE Y DESPLEGAR (M√©todo Directo)
      - name: Deploy to Firebase
        env:
          # Usamos tu secreto directamente
          SA_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_NCLEX_LIBRARY_9E9E7 }}
          PROJECT_ID: nclex-library-9e9e7
        run: |
          # Instalar CLI oficial
          npm install -g firebase-tools
          
          # Autenticaci√≥n manual con archivo de servicio
          echo "$SA_KEY" > service_account.json
          export GOOGLE_APPLICATION_CREDENTIALS="$(pwd)/service_account.json"
          
          # Despliegue forzado solo del hosting
          # --non-interactive: evita que pregunte cosas
          # --debug: nos dar√° m√°s info si falla
          firebase deploy --only hosting --project $PROJECT_ID --non-interactive
