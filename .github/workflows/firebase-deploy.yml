name: Deploy Ultimate (Fixed & Robust)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      # 1. Descargar C√≥digo
      - name: üì• Descargar C√≥digo
        uses: actions/checkout@v4

      # 2. Configurar Node (Para ejecutar tu script generador)
      - name: ‚ö° Configurar Motor Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # 3. Autenticar GitHub CLI (Ubuntu ya trae 'gh' instalado, solo hay que loguearse)
      # ESTO DEBE IR ANTES DEL SCRIPT
      - name: üîê Autenticar GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "${GH_TOKEN}" | gh auth login --with-token

      # 4. TU SCRIPT GENERADOR (Ahora s√≠ funcionar√° el 'gh release view')
      - name: üìö Generar Cat√°logo Inteligente
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          node -e "
          const fs = require('fs');
          const path = require('path');
          const { promisify } = require('util');
          const exec = promisify(require('child_process').exec);

          async function buildCatalog() {
            console.log('üíé Iniciando generador Premium...');
            const repo = process.env.REPO;
            
            try {
              const dir = 'library';
              if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });

              // INTENTO 1: GitHub CLI (Ahora s√≠ funcionar√° porque ya nos autenticamos arriba)
              console.log('Tentativa 1: Usando GitHub CLI...');
              const { stdout } = await exec('gh release view BOOKS --json assets,createdAt');
              const release = JSON.parse(stdout);
              
              const items = (release.assets || [])
                .filter(a => a.name.toLowerCase().endsWith('.pdf'))
                .map(a => ({
                  id: String(a.id || Date.now()),
                  title: a.name.replace(/_/g, ' ').replace(/-/g, ' ').replace(/\.pdf$/i, ''),
                  type: 'pdf',
                  fileUrl: a.url || a.downloadUrl,
                  size: a.size ? (a.size / 1024 / 1024).toFixed(2) + ' MB' : 'N/A',
                  date: release.createdAt
                }));

              console.log(\`‚úÖ Cat√°logo generado con \${items.length} libros (V√≠a CLI)\`);
              save(items);
              
            } catch (ghError) {
              console.log('‚ö†Ô∏è CLI fall√≥ o no encontr√≥ release, probando API directa...');
              // INTENTO 2: API Directa (Fallback)
              try {
                const url = \`https://api.github.com/repos/\${repo}/releases/tags/BOOKS\`;
                const headers = { 'User-Agent': 'NCLEX-Bot' };
                if (process.env.GH_TOKEN) headers['Authorization'] = \`Bearer \${process.env.GH_TOKEN}\`;

                const response = await fetch(url, { headers });
                if (!response.ok) throw new Error(\`API Status \${response.status}\`);

                const data = await response.json();
                const items = (data.assets || [])
                  .filter(a => a.name.toLowerCase().endsWith('.pdf'))
                  .map(a => ({
                    id: String(a.id),
                    title: a.name.replace(/_/g, ' ').replace(/-/g, ' ').replace(/\.pdf$/i, ''),
                    fileUrl: a.browser_download_url,
                    size: (a.size / 1024 / 1024).toFixed(2) + ' MB',
                    date: a.created_at
                  }));

                console.log(\`‚úÖ Cat√°logo generado con \${items.length} libros (V√≠a API)\`);
                save(items);
              } catch (apiError) {
                 console.error('‚ùå Todo fall√≥. Se genera cat√°logo vac√≠o.');
                 save([]);
              }
            }
          }

          function save(data) {
            const filePath = path.join('library', 'catalog.json');
            fs.writeFileSync(filePath, JSON.stringify(data, null, 2));
          }

          buildCatalog();
          "

      # 5. DESPLIEGUE BLINDADO (Usamos Docker para evitar el error 'exit code 1')
      - name: üöÄ Desplegar a Firebase (Docker)
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only hosting
        env:
          GCP_SA_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_NCLEX_LIBRARY_9E9E7 }}
          PROJECT_ID: nclex-library-9e9e7
