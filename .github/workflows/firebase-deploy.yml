name: Deploy Ultimate (Docker + AutoCatalog)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      # 1. Preparar el terreno
      - name: üì• Descargar C√≥digo
        uses: actions/checkout@v4

      - name: ‚ö° Configurar Motor Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. GENERADOR DE CAT√ÅLOGO H√çBRIDO
      # Este script crea el "Men√∫" de libros antes de subir la web para que cargue instant√°neo.
      - name: üìö Generar Cat√°logo Inteligente
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          node -e '
            const fs = require("fs");
            const path = require("path");

            async function buildCatalog() {
              console.log("üíé Iniciando generador Premium...");
              const repo = process.env.REPO;
              // Usamos la API p√∫blica para m√°xima compatibilidad
              const url = `https://api.github.com/repos/${repo}/releases/tags/BOOKS`;
              
              try {
                // Header User-Agent es obligatorio para la API de GitHub
                const headers = { "User-Agent": "NCLEX-Ultimate-Bot" };
                if (process.env.GH_TOKEN) headers["Authorization"] = `Bearer ${process.env.GH_TOKEN}`;

                const res = await fetch(url, { headers });
                
                if (!res.ok) {
                   console.log(`‚ö†Ô∏è Aviso: API GitHub respondi√≥ ${res.status}. Se usar√° modo Cliente-Side.`);
                   // Creamos array vac√≠o, el JS del cliente se encargar√° del fallback
                   save([]); 
                   return;
                }

                const data = await res.json();
                const items = (data.assets || [])
                  .filter(a => a.name.toLowerCase().endsWith(".pdf"))
                  .map(a => {
                    // Limpieza de t√≠tulo profesional
                    const cleanName = a.name
                      .replace(/_/g, " ")
                      .replace(/-/g, " ")
                      .replace(/\.pdf$/i, "");
                    
                    return {
                      id: String(a.id),
                      title: cleanName,
                      type: "pdf",
                      fileUrl: a.browser_download_url,
                      size: (a.size / 1024 / 1024).toFixed(2) + " MB",
                      date: a.created_at
                    };
                  });

                save(items);
                console.log(`‚úÖ Cat√°logo generado con ${items.length} obras maestras.`);

              } catch (error) {
                console.error("‚ùå Error en build (No cr√≠tico):", error.message);
                save([]); // Fallback seguro
              }
            }

            function save(data) {
              const dir = "library";
              if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
              fs.writeFileSync(path.join(dir, "catalog.json"), JSON.stringify(data, null, 2));
            }

            buildCatalog();
          '

      # 3. DESPLIEGUE BLINDADO (Usando Docker)
      # w9jds/firebase-action es la herramienta m√°s robusta que existe para GitHub Actions.
      - name: üöÄ Desplegar a Firebase (Docker)
        uses: w9jds/firebase-action@master
        with:
          args: deploy --only hosting
        env:
          GCP_SA_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_NCLEX_LIBRARY_9E9E7 }}
          PROJECT_ID: nclex-library-9e9e7
